
# 金魚すくいロボット　制御 <br /> 設計書

---

# 1. 概略シーケンス図

## 1.1 起動シーケンス

~~~plantuml

@startuml a

hide footbox

participant "Browser" as  browser
entity FishingGame
entity PIXI.Application
boundary MainSene
control VPadInputManager
entity Obniz
entity RobotArms


browser -> FishingGame

FishingGame -> PIXI.Application : create

FishingGame -> Obniz : create

Obniz -> RobotArms: set
FishingGame -> RobotArms : create

FishingGame -> VPadInputManager : create


FishingGame -> MainSene : create

VPadInputManager -> MainSene : reference

MainSene -> PIXI.Application : set

@enduml

~~~

---

# 2.クラス

## 2.1 クラス一覧

| クラス名 | 説明 |
| --- | --- |
| FishingGame | ゲームのアプリケーションクラス |
| MainSene | ゲーム画面の表示クラス |
| RobotArms | ロボットアームのModelクラス |
| Motor | ロボットアームのモーターのModelクラス |
| RobotArmsController | ロボットアームの制御クラス |
| VPadInputManager | バーチャルパッドの入力制御クラス |
| InputManager | 入力制御クラス |
| PadControlModel | 方向キーの制御モデルクラス |

<br>
<br>

## 2.2 クラス図

### 2.2.1. ゲームのクラス図

~~~plantuml

@startuml

skinparam package {
  backgroundColor transparent
  borderColor darkred
}

skinparam class {
  backgroundColor LightYellow
  borderColor darkred
}

skinparam interface {
  backgroundColor LightYellow
  borderColor darkred
}

package App {

    class FishingGame
    {

    }

    package PIXI {

        class "PIXI.Application" as PIXI_Application
        class PIXI_Application
        {
            + ticker :Ticker
        }

    }

    PIXI_Application -right-* FishingGame  : Has >

}


package View {
    class MainScene
    {

    }
}


PIXI_Application -down-* MainScene : Has >

package Controller {
    class RobotArmsController
    {

    }

    class InputManager
    {
        + upDownControl : Motor
        + leftRightControl : Motor
        + InputManager(updownMotor, leftRightMotor)
    }


    class VPadInputManager
    {
        - inputLeft : InputManager
        - inputRight : InputManager

    }

    InputManager -up-* VPadInputManager : Has >
    InputManager -up-o RobotArmsController : Uses >
}


package Model {
    package Hardware {
        class HardwareModel
        {
            - #_obniz : Obniz
        }
    }

    class RobotArms
    {
        + hardwareModel : HardwareModel
        + arms2 : Motor
        + arms3 : Motor
        + arms4 : Motor
        + arms5 : Motor
    }


    class Motor
    {
        + pulse : number
    }

    class PadControlModel
    {
        + upDown : Motor
        + leftRight : Motor
    }
    
    
    Motor -down-* RobotArms : Has >

    PadControlModel -left-* RobotArms : Has >
    PadControlModel .down.o InputManager
    HardwareModel .down.o RobotArms

}

RobotArms -down-o RobotArmsController : Has >
RobotArms -left-* FishingGame : Has >

VPadInputManager .left.> MainScene : Argument >
VPadInputManager -up-* FishingGame : Has >
RobotArms .down.o MainScene


@enduml

~~~~

<br>
<br>

### 2.2.2. Obnizクラス図

~~~plantuml

@startuml Obnizクラス図

skinparam package {
  backgroundColor transparent
  borderColor darkred
}

skinparam class {
  backgroundColor LightYellow
  borderColor darkred
}

skinparam interface {
  backgroundColor LightYellow
  borderColor darkred
}


package Hardware {
    class HardwareModel
    {
        - #_obniz : Obniz
    }
}

class Obniz
{
    + wired() : Parts
    + getFreeI2C() : PeripheralI2C
    + display : Display
}

HardwareModel -down-* Obniz : Has >

class PeripheralI2C
{
    + start()
    + freq()
}

PeripheralI2C -up-* Obniz : Has >


class Display
{

}

Display -up-* Obniz : Has >

class "PCA9685\n（サーボモータードライバIC）" as PCA9685
class PCA9685
{
    + freq()
}

Obniz .left.> PCA9685
PeripheralI2C ..o PCA9685

@enduml

~~~

---

## 初期化シーケンス

~~~plantuml

@startuml obniz初期化シーケンス

hide footbox

participant "HardwareModel\n（ハードウェアモデルクラス）" as HardwareModel
participant "Obniz" as Obniz
participant PeripheralI2C
participant "PCA9685\n（サーボモータードライバIC）" as PCA9685

activate HardwareModel
create Obniz
HardwareModel -> Obniz : new()
activate Obniz
    HardwareModel <-- Obniz : obnize
deactivate Obniz

    HardwareModel --> Obniz : onconnect()
    activate Obniz

        Obniz -> Obniz : getFreeI2C() : PeripheralI2C
        activate Obniz
            Obniz --> Obniz : i2c
        deactivate Obniz

        Obniz -> PeripheralI2C : start()
        activate PeripheralI2C            
        deactivate  PeripheralI2C

        Obniz -> Obniz : wired() : PCA9685
        activate Obniz
            create PCA9685
            Obniz -> PCA9685 : new ()
            activate PCA9685
                Obniz --> PCA9685
            deactivate PCA9685

            Obniz --> Obniz : driver
        deactivate Obniz

        note right of Obniz 
            接続表示
        endnote
        Obniz -> Display : print
        activate Display
        deactivate Display



    deactivate Obniz

deactivate Obniz

deactivate HardwareModel

@enduml

~~~

## 3.2. 方向キー入力シーケンス

~~~plantuml

hide footbox

actor User
participant MainSene
participant document

User --> MainSene : 方向キー入力

    document -> MainSene :update()
    activate MainSene
        MainSene -> InputManager : checkDirection()
        activate InputManager
            MainSene <-- InputManager : dir
        deactivate InputManager

        alt 上方向キーが押されている
            note over of MainSene
                up++
            endnote
        else 左方向キーが押されている
            note over of MainSene
                left++
            endnote
        else 右方向キーが押されている
            note over of MainSene
                right++
            endnote
        else 下方向キーが押されている
            note over of MainSene
                down++
            endnote
        end
    deactivate MainSene

User --> MainSene : 方向キーを離す

    document -> MainSene : update()
    activate MainSene
        MainSene -> InputManager : checkButton()
        activate InputManager
            MainSene <-- InputManager : 
        deactivate InputManager

        alt 上方向キーが離された
            MainSene -> MainSene : onButtonRelease()
            activate MainSene
                MainSene -> RobotArmsController : drive()
                activate RobotArmsController
                deactivate RobotArmsController
                MainSene -> MainSene : resetDirection()
                activate MainSene
                deactivate MainSene
            deactivate MainSene
        else 左方向キーが離された。
            MainSene -> MainSene : onButtonRelease()
            activate MainSene
                MainSene -> RobotArmsController : drive()
                activate RobotArmsController
                deactivate RobotArmsController
                MainSene -> MainSene : resetDirection()
                activate MainSene
                deactivate MainSene
            deactivate MainSene
        else 右方向キーが離された。
            MainSene -> MainSene : onButtonRelease()
            activate MainSene
                MainSene -> RobotArmsController : drive()
                activate RobotArmsController
                deactivate RobotArmsController
                MainSene -> MainSene : resetDirection()
                activate MainSene
                deactivate MainSene
            deactivate MainSene
        else 下方向キーが離された。
            MainSene -> MainSene : onButtonRelease()
            activate MainSene
                MainSene -> RobotArmsController : drive()
                activate RobotArmsController
                deactivate RobotArmsController
                MainSene -> MainSene : resetDirection()
                activate MainSene
                deactivate MainSene
            deactivate MainSene
        end

    deactivate MainSene

~~~